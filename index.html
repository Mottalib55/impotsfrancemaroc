<!DOCTYPE html>
<html lang="fr" class="antialiased bg-slate-50 text-slate-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparateur Fiscal : France vs Maroc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .toggle-checkbox:checked {
            right: 0;
            border-color: #0f172a;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #0f172a;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .transition-all-300 { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        /* Remove number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">

    <!-- Header -->
    <header class="w-full max-w-6xl mb-8 flex flex-col md:flex-row items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-white border border-slate-200 rounded-lg shadow-sm text-slate-900">
                <span class="iconify w-6 h-6" data-icon="lucide:scale" data-stroke-width="1.5"></span>
            </div>
            <div>
                <h1 class="text-lg font-semibold tracking-tight text-slate-900">ParitéFiscale</h1>
                <p class="text-xs text-slate-500 font-medium tracking-tight">Maroc vs France • Simulateur de Pression Fiscale</p>
            </div>
        </div>
        <div class="mt-4 md:mt-0 flex gap-4 text-xs font-medium text-slate-500">
            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-white border border-slate-200 rounded-full shadow-sm">
                <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                Maroc (MAD)
            </div>
            <div class="flex items-center gap-1.5 px-3 py-1.5 bg-white border border-slate-200 rounded-full shadow-sm">
                <span class="w-2 h-2 rounded-full bg-indigo-500"></span>
                France (EUR)
            </div>
        </div>
    </header>

    <!-- Main Configuration Panel -->
    <main class="w-full max-w-6xl space-y-6">

        <!-- Input Section -->
        <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 via-slate-200 to-indigo-500"></div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Salary Inputs -->
                <div class="space-y-5">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-xs font-semibold uppercase tracking-tight text-slate-500">Salaire Brut</label>
                        <div class="flex bg-slate-100 rounded-lg p-0.5">
                            <button id="period-monthly" class="px-3 py-1 text-xs font-medium rounded-md bg-white shadow-sm text-slate-900 transition-all-300">Mensuel</button>
                            <button id="period-annual" class="px-3 py-1 text-xs font-medium rounded-md text-slate-500 hover:text-slate-900 transition-all-300">Annuel</button>
                        </div>
                    </div>

                    <div class="relative grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Divider "OU" -->
                        <div class="hidden sm:flex absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 w-8 h-8 items-center justify-center bg-white rounded-full border border-slate-200 shadow-sm">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">ou</span>
                        </div>
                        <div class="sm:hidden w-full text-center -my-2">
                            <span class="text-[10px] font-bold text-slate-300 uppercase bg-white px-2 relative z-10">ou</span>
                        </div>

                        <!-- Morocco Input -->
                        <div class="relative group">
                            <label class="block text-xs font-medium text-slate-500 mb-1.5">Maroc (MAD)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-medium text-sm">Dh</span>
                                <input type="number" id="input-mad" class="w-full pl-10 pr-4 py-2.5 text-sm font-semibold text-slate-900 bg-white border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all-300" placeholder="0">
                            </div>
                        </div>

                        <!-- France Input -->
                        <div class="relative group">
                            <label class="block text-xs font-medium text-slate-500 mb-1.5">France (EUR)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-medium text-sm">€</span>
                                <input type="number" id="input-eur" class="w-full pl-10 pr-4 py-2.5 text-sm font-semibold text-slate-900 bg-white border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all-300" placeholder="0">
                            </div>
                            <div class="flex items-center justify-end gap-2 mt-2">
                                <span class="text-[10px] text-slate-400 font-medium">Statut Cadre</span>
                                <button id="toggle-cadre" class="relative inline-flex h-4 w-7 items-center rounded-full bg-slate-200 transition-colors focus:outline-none">
                                    <span class="translate-x-0.5 inline-block h-2.5 w-2.5 transform rounded-full bg-white transition-transform shadow-sm"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 mt-2">
                        <span class="text-[10px] text-slate-400 font-medium">Taux DH/EUR du jour :</span>
                        <input type="number" id="exchange-rate" value="10.8" class="w-16 py-0.5 px-1 text-[10px] font-mono text-slate-500 bg-slate-50 border border-slate-200 rounded text-center focus:outline-none focus:border-slate-400">
                        <span id="rate-status" class="text-[10px] text-emerald-500"></span>
                    </div>
                </div>

                <!-- Family Situation -->
                <div class="space-y-5 lg:border-l lg:border-slate-100 lg:pl-8">
                    <label class="block text-xs font-semibold uppercase tracking-tight text-slate-500 mb-2">Situation Familiale</label>

                    <div class="space-y-4">
                        <div>
                            <span class="text-xs font-medium text-slate-600 mb-2 block">Statut Marital</span>
                            <div class="flex w-full bg-slate-50 border border-slate-200 rounded-lg p-1">
                                <button id="status-single" class="flex-1 py-1.5 text-[11px] font-medium rounded-md bg-white shadow-sm text-slate-900 border border-slate-100 transition-all-300">Célibataire</button>
                                <button id="status-married" class="flex-1 py-1.5 text-[11px] font-medium rounded-md text-slate-500 hover:text-slate-900 transition-all-300">Marié(e)</button>
                                <button id="status-divorced" class="flex-1 py-1.5 text-[11px] font-medium rounded-md text-slate-500 hover:text-slate-900 transition-all-300">Divorcé(e)</button>
                            </div>
                        </div>

                        <div>
                            <span class="text-xs font-medium text-slate-600 mb-2 block">Enfants à charge</span>
                            <div class="flex items-center w-full bg-white border border-slate-200 rounded-lg h-[38px]">
                                <button id="child-minus" class="w-10 h-full flex items-center justify-center text-slate-400 hover:text-slate-900 hover:bg-slate-50 rounded-l-lg transition-colors border-r border-slate-100">
                                    <span class="iconify" data-icon="lucide:minus" width="14"></span>
                                </button>
                                <div id="children-display" class="flex-1 text-center text-sm font-semibold text-slate-900 select-none">0</div>
                                <button id="child-plus" class="w-10 h-full flex items-center justify-center text-slate-400 hover:text-slate-900 hover:bg-slate-50 rounded-r-lg transition-colors border-l border-slate-100">
                                    <span class="iconify" data-icon="lucide:plus" width="14"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Comparison Results -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- MAROC COLUMN -->
            <article class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden flex flex-col">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded bg-emerald-100 flex items-center justify-center text-emerald-700 font-bold text-[10px]">MA</div>
                        <h2 class="text-sm font-semibold text-slate-900">Maroc</h2>
                    </div>
                    <span class="text-[10px] font-medium text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-100">IR Progressif</span>
                </div>

                <div class="p-6 flex-1 flex flex-col gap-6">
                    <!-- KPIs -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 rounded-lg bg-slate-50 border border-slate-100">
                            <p class="text-[11px] font-medium uppercase text-slate-500 mb-1">Net "En Poche"</p>
                            <p class="text-2xl font-semibold text-slate-900 tracking-tight" id="ma-net">0 <span class="text-sm font-normal text-slate-400">MAD</span></p>
                            <p class="text-[10px] text-slate-400 mt-1" id="ma-net-eur">≈ 0 €</p>
                        </div>
                        <div class="p-4 rounded-lg bg-slate-50 border border-slate-100">
                            <p class="text-[11px] font-medium uppercase text-slate-500 mb-1">Taux d'Imposition</p>
                            <p class="text-2xl font-semibold text-emerald-600 tracking-tight" id="ma-rate">0%</p>
                            <p class="text-[10px] text-slate-400 mt-1">Pression Totale</p>
                        </div>
                    </div>

                    <!-- Stacked Bar Chart -->
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] font-medium text-slate-500 uppercase tracking-wide">
                            <span>Distribution</span>
                            <span>100% du Brut</span>
                        </div>
                        <div class="h-6 w-full bg-slate-100 rounded-md overflow-hidden flex shadow-inner relative group">
                            <!-- Net -->
                            <div id="bar-ma-net" class="h-full bg-emerald-500 transition-all-300 relative group/segment" style="width: 60%">
                                <div class="opacity-0 group-hover/segment:opacity-100 absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[10px] py-1 px-2 rounded whitespace-nowrap z-10 pointer-events-none shadow-lg">Salaire Net</div>
                            </div>
                            <!-- Impot -->
                            <div id="bar-ma-tax" class="h-full bg-emerald-300 transition-all-300 relative group/segment" style="width: 20%">
                                <div class="opacity-0 group-hover/segment:opacity-100 absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[10px] py-1 px-2 rounded whitespace-nowrap z-10 pointer-events-none shadow-lg">Impôt (IR)</div>
                            </div>
                            <!-- Cotis -->
                            <div id="bar-ma-soc" class="h-full bg-emerald-100 transition-all-300 relative group/segment" style="width: 20%">
                                <div class="opacity-0 group-hover/segment:opacity-100 absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[10px] py-1 px-2 rounded whitespace-nowrap z-10 pointer-events-none shadow-lg">Cotisations</div>
                            </div>
                        </div>
                        <div class="flex justify-between text-[10px] text-slate-400">
                            <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-emerald-500"></div>Net</div>
                            <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-emerald-300"></div>Impôt</div>
                            <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-emerald-100"></div>Social</div>
                        </div>
                    </div>

                    <!-- Breakdown Table -->
                    <div class="mt-2 border rounded-lg border-slate-200 overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-[10px] uppercase text-slate-500 font-semibold border-b border-slate-200">
                                <tr>
                                    <th class="px-4 py-3">Poste</th>
                                    <th class="px-4 py-3 text-right">Montant</th>
                                    <th class="px-4 py-3 text-right text-slate-400">%</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="ma-table-body">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </article>

            <!-- FRANCE COLUMN -->
            <article class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden flex flex-col">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-[10px]">FR</div>
                        <h2 class="text-sm font-semibold text-slate-900">France</h2>
                    </div>
                    <span class="text-[10px] font-medium text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full border border-indigo-100">Quotient Familial</span>
                </div>

                <div class="p-6 flex-1 flex flex-col gap-6">
                    <!-- KPIs -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 rounded-lg bg-slate-50 border border-slate-100">
                            <p class="text-[11px] font-medium uppercase text-slate-500 mb-1">Net "En Poche"</p>
                            <p class="text-2xl font-semibold text-slate-900 tracking-tight" id="fr-net">0 <span class="text-sm font-normal text-slate-400">€</span></p>
                            <p class="text-[10px] text-slate-400 mt-1" id="fr-net-mad">≈ 0 MAD</p>
                        </div>
                        <div class="p-4 rounded-lg bg-slate-50 border border-slate-100">
                            <p class="text-[11px] font-medium uppercase text-slate-500 mb-1">Taux d'Imposition</p>
                            <p class="text-2xl font-semibold text-indigo-600 tracking-tight" id="fr-rate">0%</p>
                            <p class="text-[10px] text-slate-400 mt-1">Pression Totale</p>
                        </div>
                    </div>

                    <!-- Stacked Bar Chart -->
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] font-medium text-slate-500 uppercase tracking-wide">
                            <span>Distribution</span>
                            <span>100% du Brut</span>
                        </div>
                        <div class="h-6 w-full bg-slate-100 rounded-md overflow-hidden flex shadow-inner relative">
                            <!-- Net -->
                            <div id="bar-fr-net" class="h-full bg-indigo-500 transition-all-300 relative group/segment" style="width: 60%">
                                <div class="opacity-0 group-hover/segment:opacity-100 absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[10px] py-1 px-2 rounded whitespace-nowrap z-10 pointer-events-none shadow-lg">Salaire Net</div>
                            </div>
                            <!-- Impot -->
                            <div id="bar-fr-tax" class="h-full bg-indigo-300 transition-all-300 relative group/segment" style="width: 20%">
                                <div class="opacity-0 group-hover/segment:opacity-100 absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[10px] py-1 px-2 rounded whitespace-nowrap z-10 pointer-events-none shadow-lg">Impôt (IR)</div>
                            </div>
                            <!-- Cotis -->
                            <div id="bar-fr-soc" class="h-full bg-indigo-100 transition-all-300 relative group/segment" style="width: 20%">
                                <div class="opacity-0 group-hover/segment:opacity-100 absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[10px] py-1 px-2 rounded whitespace-nowrap z-10 pointer-events-none shadow-lg">Cotisations</div>
                            </div>
                        </div>
                        <div class="flex justify-between text-[10px] text-slate-400">
                            <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-indigo-500"></div>Net</div>
                            <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-indigo-300"></div>Impôt</div>
                            <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full bg-indigo-100"></div>Social</div>
                        </div>
                    </div>

                    <!-- Breakdown Table -->
                    <div class="mt-2 border rounded-lg border-slate-200 overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-[10px] uppercase text-slate-500 font-semibold border-b border-slate-200">
                                <tr>
                                    <th class="px-4 py-3">Poste</th>
                                    <th class="px-4 py-3 text-right">Montant</th>
                                    <th class="px-4 py-3 text-right text-slate-400">%</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="fr-table-body">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </article>

        </div>

        <!-- Verdict Banner -->
        <div class="bg-slate-900 text-white rounded-xl shadow-lg p-6 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <span class="iconify w-8 h-8 text-yellow-400" data-icon="lucide:trophy"></span>
                <div>
                    <h3 class="font-semibold text-lg tracking-tight" id="verdict-title">Analyse Prête</h3>
                    <p class="text-sm text-slate-400" id="verdict-text">Saisissez votre salaire pour comparer.</p>
                </div>
            </div>
            <div class="text-right flex flex-col items-end">
                <p class="text-xs uppercase tracking-widest text-slate-500 font-medium mb-1">Différence Annuelle</p>
                <div class="flex flex-col items-end">
                    <p class="text-2xl font-bold font-mono tracking-tight text-white leading-none mb-1" id="verdict-diff">--</p>
                    <p class="text-sm font-medium text-slate-400 font-mono tracking-tight" id="verdict-diff-eur"></p>
                </div>
            </div>
        </div>

        <p class="text-center text-[10px] text-slate-400 mt-8 pb-4 max-w-2xl mx-auto leading-relaxed">
            Avertissement Légal : Cet outil est fourni à titre indicatif uniquement. Les lois fiscales en France et au Maroc sont complexes et sujettes à modifications (Loi de Finances 2025). Les cotisations sociales sont des estimations moyennes. Les calculs excluent les niches fiscales complexes.
        </p>

    </main>

    <script>
        // --- CONSTANTS & CONFIG ---
        const TAX_CONFIG = {
            fr: {
                brackets: [
                    { limit: 11294, rate: 0 },
                    { limit: 28797, rate: 0.11 },
                    { limit: 82341, rate: 0.30 },
                    { limit: 177106, rate: 0.41 },
                    { limit: Infinity, rate: 0.45 }
                ],
                cotis_rate_noncadre: 0.22,
                cotis_rate_cadre: 0.25,
                abattement: 0.10
            },
            ma: {
                brackets: [
                    { limit: 40000, rate: 0, deduct: 0 },
                    { limit: 60000, rate: 0.10, deduct: 4000 },
                    { limit: 80000, rate: 0.20, deduct: 10000 },
                    { limit: 100000, rate: 0.30, deduct: 18000 },
                    { limit: 180000, rate: 0.34, deduct: 22000 },
                    { limit: Infinity, rate: 0.37, deduct: 27400 }
                ],
                cnss_rate: 0.0448,
                cnss_ceiling_monthly: 6000,
                amo_rate: 0.0226,
                family_deduction: 500,
                family_deduction_cap: 3000
            }
        };

        // --- STATE ---
        const state = {
            salaryInput: 0,
            salaryCurrency: 'EUR',
            exchangeRate: 10.8,
            period: 'monthly',
            status: 'single',
            children: 0,
            isCadre: false
        };

        // --- DOM ELEMENTS ---
        const els = {
            inputMad: document.getElementById('input-mad'),
            inputEur: document.getElementById('input-eur'),
            inputRate: document.getElementById('exchange-rate'),
            btnMonthly: document.getElementById('period-monthly'),
            btnAnnual: document.getElementById('period-annual'),

            btnSingle: document.getElementById('status-single'),
            btnMarried: document.getElementById('status-married'),
            btnDivorced: document.getElementById('status-divorced'),

            btnChildMinus: document.getElementById('child-minus'),
            btnChildPlus: document.getElementById('child-plus'),
            displayChildren: document.getElementById('children-display'),

            toggleCadre: document.getElementById('toggle-cadre'),

            maNet: document.getElementById('ma-net'),
            maNetEur: document.getElementById('ma-net-eur'),
            maRate: document.getElementById('ma-rate'),
            maTable: document.getElementById('ma-table-body'),
            barMaNet: document.getElementById('bar-ma-net'),
            barMaTax: document.getElementById('bar-ma-tax'),
            barMaSoc: document.getElementById('bar-ma-soc'),

            frNet: document.getElementById('fr-net'),
            frNetMad: document.getElementById('fr-net-mad'),
            frRate: document.getElementById('fr-rate'),
            frTable: document.getElementById('fr-table-body'),
            barFrNet: document.getElementById('bar-fr-net'),
            barFrTax: document.getElementById('bar-fr-tax'),
            barFrSoc: document.getElementById('bar-fr-soc'),

            verdictTitle: document.getElementById('verdict-title'),
            verdictText: document.getElementById('verdict-text'),
            verdictDiff: document.getElementById('verdict-diff'),
            verdictDiffEur: document.getElementById('verdict-diff-eur'),
        };

        // --- FORMATTERS ---
        const formatMoney = (amount, currency) => {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: currency, maximumFractionDigits: 0 }).format(amount);
        };
        const formatPct = (val) => (val * 100).toFixed(1) + '%';

        // --- LOGIC ---

        function calculateFrance() {
            let annualGrossEur = state.salaryInput;
            if (state.salaryCurrency === 'MAD') annualGrossEur /= state.exchangeRate;
            if (state.period === 'monthly') annualGrossEur *= 12;

            if (annualGrossEur === 0) return null;

            const cotisRate = state.isCadre ? TAX_CONFIG.fr.cotis_rate_cadre : TAX_CONFIG.fr.cotis_rate_noncadre;
            const socialContrib = annualGrossEur * cotisRate;

            const netImposable = (annualGrossEur - socialContrib) * 0.90;

            let parts = state.status === 'married' ? 2 : 1;

            if (state.children > 0) {
                if (state.children === 1) parts += 0.5;
                else if (state.children === 2) parts += 1.0;
                else parts += 1.0 + (state.children - 2);
            }

            const incomePerPart = netImposable / parts;
            let taxPerPart = 0;
            let previousLimit = 0;

            for (let bracket of TAX_CONFIG.fr.brackets) {
                if (incomePerPart > previousLimit) {
                    const taxableInBracket = Math.min(incomePerPart, bracket.limit) - previousLimit;
                    taxPerPart += taxableInBracket * bracket.rate;
                    previousLimit = bracket.limit;
                }
            }

            const totalTax = taxPerPart * parts;
            const netInPocket = annualGrossEur - socialContrib - totalTax;

            return {
                gross: annualGrossEur,
                social: socialContrib,
                tax: totalTax,
                net: netInPocket,
                rate: (socialContrib + totalTax) / annualGrossEur
            };
        }

        function calculateMorocco() {
            let annualGrossMad = state.salaryInput;
            if (state.salaryCurrency === 'EUR') annualGrossMad *= state.exchangeRate;
            if (state.period === 'monthly') annualGrossMad *= 12;

            if (annualGrossMad === 0) return null;

            const cnssBase = Math.min(annualGrossMad, 72000);
            const cnss = cnssBase * TAX_CONFIG.ma.cnss_rate;
            const amo = annualGrossMad * TAX_CONFIG.ma.amo_rate;
            const socialContrib = cnss + amo;

            const grossLessSocial = annualGrossMad - socialContrib;
            const proDeduction = Math.min(grossLessSocial * 0.20, 30000);
            const netImposable = grossLessSocial - proDeduction;

            let tax = 0;
            for (let bracket of TAX_CONFIG.ma.brackets) {
                if (netImposable <= bracket.limit) {
                    tax = (netImposable * bracket.rate) - bracket.deduct;
                    break;
                }
                if (bracket.limit === Infinity) {
                    tax = (netImposable * bracket.rate) - bracket.deduct;
                }
            }
            if(tax < 0) tax = 0;

            // Abattement familial (toujours appliqué)
            const spouseCount = state.status === 'married' ? 1 : 0;
            const dependants = spouseCount + state.children;
            const familyReduc = Math.min(dependants * TAX_CONFIG.ma.family_deduction, TAX_CONFIG.ma.family_deduction_cap);
            const taxBeforeReduc = tax;
            tax = Math.max(0, tax - familyReduc);

            const netInPocket = annualGrossMad - socialContrib - tax;

            return {
                gross: annualGrossMad,
                social: socialContrib,
                tax: tax,
                taxBeforeReduc: taxBeforeReduc,
                familyReduc: familyReduc,
                dependants: dependants,
                net: netInPocket,
                rate: (socialContrib + tax) / annualGrossMad
            };
        }

        // --- UI UPDATER ---

        function render() {
            const frData = calculateFrance();
            const maData = calculateMorocco();

            if (!frData || !maData) {
                els.verdictDiff.textContent = "--";
                els.verdictDiffEur.textContent = "";
                return;
            }

            const maMultiplier = state.period === 'monthly' ? 1/12 : 1;

            els.maNet.innerHTML = `${formatMoney(maData.net * maMultiplier, 'MAD')} <span class="text-sm font-normal text-slate-400">MAD</span>`;
            els.maNetEur.textContent = `≈ ${formatMoney((maData.net * maMultiplier) / state.exchangeRate, 'EUR')}`;
            els.maRate.textContent = formatPct(maData.rate);

            const maTotal = maData.gross;
            els.barMaNet.style.width = (maData.net / maTotal * 100) + '%';
            els.barMaTax.style.width = (maData.tax / maTotal * 100) + '%';
            els.barMaSoc.style.width = (maData.social / maTotal * 100) + '%';

            const familyReducRow = maData.familyReduc > 0
                ? `<tr class="text-emerald-600"><td class="px-4 py-2 pl-6 text-xs">Abattement familial (${maData.dependants} pers.)</td><td class="px-4 py-2 text-right text-xs">+${formatMoney(maData.familyReduc * maMultiplier, 'MAD')}</td><td class="px-4 py-2 text-right text-xs">-</td></tr>`
                : '';

            els.maTable.innerHTML = `
                <tr><td class="px-4 py-2 font-medium">Salaire Brut</td><td class="px-4 py-2 text-right">${formatMoney(maData.gross * maMultiplier, 'MAD')}</td><td class="px-4 py-2 text-right text-slate-400">100%</td></tr>
                <tr class="text-slate-500"><td class="px-4 py-2 pl-6 text-xs">Social (CNSS/AMO)</td><td class="px-4 py-2 text-right text-xs">-${formatMoney(maData.social * maMultiplier, 'MAD')}</td><td class="px-4 py-2 text-right text-xs">${formatPct(maData.social/maData.gross)}</td></tr>
                <tr class="text-slate-500"><td class="px-4 py-2 pl-6 text-xs">Impôt (IR)</td><td class="px-4 py-2 text-right text-xs">-${formatMoney(maData.tax * maMultiplier, 'MAD')}</td><td class="px-4 py-2 text-right text-xs">${formatPct(maData.tax/maData.gross)}</td></tr>
                ${familyReducRow}
                <tr class="bg-emerald-50/50 font-semibold text-emerald-900"><td class="px-4 py-2">Salaire Net</td><td class="px-4 py-2 text-right">${formatMoney(maData.net * maMultiplier, 'MAD')}</td><td class="px-4 py-2 text-right text-emerald-600">${formatPct(maData.net/maData.gross)}</td></tr>
            `;

            els.frNet.innerHTML = `${formatMoney(frData.net * maMultiplier, 'EUR')} <span class="text-sm font-normal text-slate-400">€</span>`;
            els.frNetMad.textContent = `≈ ${formatMoney((frData.net * maMultiplier) * state.exchangeRate, 'MAD')}`;
            els.frRate.textContent = formatPct(frData.rate);

            const frTotal = frData.gross;
            els.barFrNet.style.width = (frData.net / frTotal * 100) + '%';
            els.barFrTax.style.width = (frData.tax / frTotal * 100) + '%';
            els.barFrSoc.style.width = (frData.social / frTotal * 100) + '%';

            els.frTable.innerHTML = `
                <tr><td class="px-4 py-2 font-medium">Salaire Brut</td><td class="px-4 py-2 text-right">${formatMoney(frData.gross * maMultiplier, 'EUR')}</td><td class="px-4 py-2 text-right text-slate-400">100%</td></tr>
                <tr class="text-slate-500"><td class="px-4 py-2 pl-6 text-xs">Charges Sociales (Est.)</td><td class="px-4 py-2 text-right text-xs">-${formatMoney(frData.social * maMultiplier, 'EUR')}</td><td class="px-4 py-2 text-right text-xs">${formatPct(frData.social/frData.gross)}</td></tr>
                <tr class="text-slate-500"><td class="px-4 py-2 pl-6 text-xs">Impôt (IR)</td><td class="px-4 py-2 text-right text-xs">-${formatMoney(frData.tax * maMultiplier, 'EUR')}</td><td class="px-4 py-2 text-right text-xs">${formatPct(frData.tax/frData.gross)}</td></tr>
                <tr class="bg-indigo-50/50 font-semibold text-indigo-900"><td class="px-4 py-2">Salaire Net</td><td class="px-4 py-2 text-right">${formatMoney(frData.net * maMultiplier, 'EUR')}</td><td class="px-4 py-2 text-right text-indigo-600">${formatPct(frData.net/frData.gross)}</td></tr>
            `;

            const frNetInMad = frData.net * state.exchangeRate;
            const maNetInMad = maData.net;
            const diffAnnualMad = Math.abs(frNetInMad - maNetInMad);
            const diffAnnualEur = diffAnnualMad / state.exchangeRate;

            const winner = frNetInMad > maNetInMad ? 'France' : 'Maroc';

            els.verdictDiff.textContent = formatMoney(diffAnnualEur, 'EUR');
            els.verdictDiffEur.textContent = formatMoney(diffAnnualMad, 'MAD');

            if(winner === 'Maroc') {
                els.verdictTitle.textContent = "Le Maroc offre un meilleur net";
                els.verdictTitle.className = "font-semibold text-lg tracking-tight text-emerald-400";
                els.verdictText.innerHTML = `Pour le même coût brut, vous gardez plus au Maroc.<br>Taux d'imposition effectif : <b>France ${formatPct(frData.rate)}</b> vs <b>Maroc ${formatPct(maData.rate)}</b>`;
            } else {
                els.verdictTitle.textContent = "La France offre un meilleur net";
                els.verdictTitle.className = "font-semibold text-lg tracking-tight text-indigo-400";
                els.verdictText.innerHTML = `La pression fiscale est moindre en France pour ce montant.<br>Taux d'imposition effectif : <b>France ${formatPct(frData.rate)}</b> vs <b>Maroc ${formatPct(maData.rate)}</b>`;
            }
        }

        // --- EVENT LISTENERS ---

        els.inputMad.addEventListener('input', (e) => {
            if(!e.target.value) { state.salaryInput = 0; render(); return; }
            const val = parseFloat(e.target.value);
            state.salaryInput = val;
            state.salaryCurrency = 'MAD';
            els.inputEur.value = (val / state.exchangeRate).toFixed(0);
            render();
        });

        els.inputEur.addEventListener('input', (e) => {
            if(!e.target.value) { state.salaryInput = 0; render(); return; }
            const val = parseFloat(e.target.value);
            state.salaryInput = val;
            state.salaryCurrency = 'EUR';
            els.inputMad.value = (val * state.exchangeRate).toFixed(0);
            render();
        });

        els.inputRate.addEventListener('change', (e) => {
            state.exchangeRate = parseFloat(e.target.value) || 10.8;
            render();
        });

        const setPeriod = (p) => {
            state.period = p;
            if(p === 'monthly') {
                els.btnMonthly.className = "px-3 py-1 text-xs font-medium rounded-md bg-white shadow-sm text-slate-900 transition-all-300";
                els.btnAnnual.className = "px-3 py-1 text-xs font-medium rounded-md text-slate-500 hover:text-slate-900 transition-all-300";
            } else {
                els.btnAnnual.className = "px-3 py-1 text-xs font-medium rounded-md bg-white shadow-sm text-slate-900 transition-all-300";
                els.btnMonthly.className = "px-3 py-1 text-xs font-medium rounded-md text-slate-500 hover:text-slate-900 transition-all-300";
            }
            render();
        };
        els.btnMonthly.addEventListener('click', () => setPeriod('monthly'));
        els.btnAnnual.addEventListener('click', () => setPeriod('annual'));

        const setStatus = (status) => {
            state.status = status;

            const activeClass = "flex-1 py-1.5 text-[11px] font-medium rounded-md bg-white shadow-sm text-slate-900 border border-slate-100 transition-all-300";
            const inactiveClass = "flex-1 py-1.5 text-[11px] font-medium rounded-md text-slate-500 hover:text-slate-900 transition-all-300";

            els.btnSingle.className = status === 'single' ? activeClass : inactiveClass;
            els.btnMarried.className = status === 'married' ? activeClass : inactiveClass;
            els.btnDivorced.className = status === 'divorced' ? activeClass : inactiveClass;

            render();
        };
        els.btnSingle.addEventListener('click', () => setStatus('single'));
        els.btnMarried.addEventListener('click', () => setStatus('married'));
        els.btnDivorced.addEventListener('click', () => setStatus('divorced'));

        const updateChildren = (val) => {
            if (val < 0) val = 0;
            if (val > 10) val = 10;
            state.children = val;
            els.displayChildren.textContent = state.children;
            render();
        };
        els.btnChildMinus.addEventListener('click', () => updateChildren(state.children - 1));
        els.btnChildPlus.addEventListener('click', () => updateChildren(state.children + 1));

        els.toggleCadre.addEventListener('click', () => {
            state.isCadre = !state.isCadre;
            const dot = els.toggleCadre.querySelector('span');
            if(state.isCadre) {
                els.toggleCadre.classList.replace('bg-slate-200', 'bg-indigo-500');
                dot.classList.add('translate-x-3');
                dot.classList.remove('translate-x-0.5');
            } else {
                els.toggleCadre.classList.replace('bg-indigo-500', 'bg-slate-200');
                dot.classList.remove('translate-x-3');
                dot.classList.add('translate-x-0.5');
            }
            render();
        });


        // Fetch today's exchange rate
        async function fetchExchangeRate() {
            const rateStatus = document.getElementById('rate-status');
            try {
                const response = await fetch('https://api.frankfurter.app/latest?from=EUR&to=MAD');
                const data = await response.json();
                if (data.rates && data.rates.MAD) {
                    const rate = data.rates.MAD;
                    els.inputRate.value = rate.toFixed(2);
                    state.exchangeRate = rate;
                    rateStatus.textContent = '✓';
                    rateStatus.className = 'text-[10px] text-emerald-500';
                    render();
                }
            } catch (error) {
                rateStatus.textContent = '(défaut)';
                rateStatus.className = 'text-[10px] text-slate-400';
            }
        }

        // Init
        fetchExchangeRate();
        els.inputMad.value = 40000;
        els.inputMad.dispatchEvent(new Event('input'));

    </script>

</body>
</html>
